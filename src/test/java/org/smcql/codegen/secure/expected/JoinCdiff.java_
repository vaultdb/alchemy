package org.smcql.compiler.emp.generated;



import org.bytedeco.javacpp.Loader;
import org.bytedeco.javacpp.Pointer;
import org.bytedeco.javacpp.annotation.Namespace;
import org.bytedeco.javacpp.annotation.Platform;
import org.bytedeco.javacpp.annotation.StdString;
import java.util.Map;
import java.util.HashMap;
import java.util.Iterator;

import org.smcql.config.SystemConfiguration;
import org.smcql.db.data.QueryTable;
import org.smcql.executor.plaintext.SqlQueryExecutor;
import org.smcql.type.SecureRelRecordType;
import org.smcql.util.Utilities;
import org.smcql.executor.config.ConnectionManager;







import org.smcql.compiler.emp.EmpProgram;


@Platform(include={"JoinCdiff.h"}, 
			compiler = "cpp11")





@Namespace("JoinCdiff")
public class JoinCdiff  extends EmpProgram  {

	Map<String, String> inputs = new HashMap<String, String>();
	boolean[] queryOutput = null;
	
	public JoinCdiff(int party, int port) {
		super(party, port);
		inputs.put("SeqScan4Merge", "SELECT patient_id FROM medications ORDER BY patient_id");
inputs.put("SeqScan0Merge", "SELECT patient_id, icd9 = '008.45' FROM (SELECT patient_id, icd9 FROM diagnoses) AS t ORDER BY patient_id");

	}
	

	public static class JoinCdiffClass extends Pointer {
	
        static {         
			Loader.load(); 
	       } 
       
        public JoinCdiffClass() { 	
        	allocate(); 
        	}
        private native void allocate();
        public native void addInput(@StdString String opName,  @StdString String bitString);
        public native void run(int party, int port); 
        public native void setGeneratorHost(@StdString String host);
        public native @StdString String getOutput();
        
        
	}
	
	
	   
	   
	String getInput(String sql) throws Exception {
    	SecureRelRecordType outSchema = Utilities.getOutSchemaFromSql(sql);
    	String workerId = System.getProperty("workerId");	
    	
    	ConnectionManager cm = ConnectionManager.getInstance();
   		System.out.println("Getting connection for " + workerId + " out of " + cm.getDataSources());
    					
		
    	QueryTable table = SqlQueryExecutor.query(sql, outSchema, workerId);
		return  table.toBinaryString();

    }
	   	
        @Override
        public  boolean[] runProgram() throws Exception {
        	JoinCdiffClass theQuery = new JoinCdiffClass();

	        Iterator inputItr = inputs.entrySet().iterator();
	        while(inputItr.hasNext()) {
	        	Map.Entry entry = (Map.Entry) inputItr.next();
	        	String functionName = (String) entry.getKey();
	        	String tupleBitstring = getInput((String) entry.getValue());
	        	theQuery.addInput(functionName, tupleBitstring);
	        }
	        
        	if(generatorHost != null) {
        		theQuery.setGeneratorHost(generatorHost);
        	}
        	
        	
        	theQuery.run(party, port);
        	String output = theQuery.getOutput();
	        theQuery.close();

	       boolean[] outBits = new boolean[output.length()];
	       for(int i = 0; i < output.length(); ++i) {
	    	   outBits[i] = output.charAt(i) == '1' ? true : false;
	       }
	       return outBits;
	       
        }
        



	// for testing on localhost only
	public static void main(String[] args) {
           
		int party = Integer.parseInt(args[0]);
		int port = Integer.parseInt(args[1]);
		String setupFile = Utilities.getSMCQLRoot() + "/conf/setup.localhost";
		
  	    System.setProperty("smcql.setup", setupFile);
  	    String workerId = (party == 1) ? "alice" : "bob";
  	    
  	    
  	    System.out.println("*********For party " + party + " have workerId " + workerId);
  	    
  	    System.setProperty("workerId", workerId);
  	    
		JoinCdiff qc = new JoinCdiff(party, port);
		boolean[] bits = null;
		char b;
		
		try {
			SystemConfiguration.getInstance(); // initialize config
			bits = qc.runProgram();
		} catch(Exception e) {
			System.err.println("Program execution failed!");
			e.printStackTrace();
			System.exit(-1);
		}
	       
			// write bitstring to stderr
			for(int i = 0; i < bits.length; ++i) {
				b = (bits[i] == true) ? '1' : '0';
				System.err.print(b);
			}

	        
    }        
	
    	
}